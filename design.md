# サーブ3Dシミュレーター 仕様書・設計書

## 1. プロジェクト概要

### 1.1 目的
テニスのサーブ戦術の効果を視覚的に分析するための3Dシミュレーターを開発する。アマチュアレベルでのサーブの有効性を、物理的な軌道計算とレシーバーの移動分析により定量的に評価する。
将来的にはボレー、ラリーなど他のテニスシーンにも応用可能な共通基盤として構築する。

### 1.2 対象ユーザー
- テニス愛好家（アマチュアプレイヤー）
- テニスコーチ
- 戦術研究者
- ソフトウェアエンジニア（テニス経験者）

### 1.3 技術スタック
- **ビルドツール**: Vite
- **言語**: TypeScript, JavaScript (ES6+)
- **フロントエンド**: React (Hooks)
- **3Dレンダリング**: Three.js (r128以上)
- **実行環境**: Webブラウザ (Electron化も可能な構成)

---

## 2. 機能要件

### 2.1 3D可視化機能

#### 2.1.1 コート表示
- **寸法**: 公式テニスコート規格（23.77m × 10.97m）
- **表示要素**:
  - コートサーフェス（緑色）
  - ベースライン（白線）
  - サービスライン（白線）
  - センターライン（白線）
  - シングルスライン（白線）
  - ダブルスライン（白線）
  - ネット（半透明白、高さ0.914m）

#### 2.1.2 オブジェクト表示
- **サーバーマーカー**（赤色球、半径0.3m）: X軸上を移動可能
- **レシーバーマーカー**（青色球、半径0.3m）: シングルスライン上、ベースライン位置に固定
- **レシーバー目標位置**（緑色半透明球、半径0.2m）: 計算結果に基づき表示
- **ボール**（黄色球、半径0.1m）: アニメーション可能

#### 2.1.3 軌道表示
- **サーブ軌道**（紫色線）: サーバー位置から1バウンド目、2バウンド目までの完全な軌道
- **リアルタイム更新**: パラメータ変更時に即座に再描画

#### 2.1.4 寸法表示機能（オプション）
- チェックボックスでオン/オフ切替
- 黄色の寸法線と矢印で表示:
  - コート幅（シングルス: 8.23m）
  - コート全長（23.77m）
  - ベースライン〜サービスライン（5.5m）

### 2.2 パラメータ調整機能

#### 2.2.1 サーバー設定
| パラメータ      | 範囲       | 初期値 | 単位 | 説明                                 |
| --------------- | ---------- | ------ | ---- | ------------------------------------ |
| サーバー位置(X) | 0 〜 5.485 | 1.5    | m    | センターマークからダブルスラインまで |
| 打点高さ        | 0.5 〜 2.5 | 1.0    | m    | サーブのインパクト時の高さ           |

#### 2.2.2 着弾点設定（Target Settings）
| パラメータ | 範囲           | 初期値 | 単位 | 説明                                   |
| ---------- | -------------- | ------ | ---- | -------------------------------------- |
| 着弾点 X   | -4.115 〜 4.115 | 0      | m    | 着弾位置の横方向（センターマークから） |
| 着弾点 Z   | 0.5 〜 6.4     | 4.0    | m    | 着弾位置の深さ（ネットからの距離）     |

#### 2.2.3 サーブ物理パラメータ（Physics Parameters）
| パラメータ           | 範囲         | 初期値 | 単位 | 説明                                                      |
| -------------------- | ------------ | ------ | ---- | --------------------------------------------------------- |
| サーブ速度           | 40 〜 220    | 180    | km/h | ボールの初速度                                            |
| 軌道の最高点の高さ   | 0.5 〜 10.0  | 3.0    | m    | ボールが到達する最大の高さ（地面から）                    |
| 最高点の位置         | -6.0 〜 +12.0 | 2.0    | m    | ネット(Z=0)を基準に、どこで最高点に達するか（正=相手側） |
| バウンド後速度保持率 | 20 〜 80     | 70     | %    | バウンド後に元速度の何%を保持するか                       |

#### 2.2.4 レシーバー設定
| パラメータ   | 範囲       | 初期値 | 単位 | 説明                     |
| ------------ | ---------- | ------ | ---- | ------------------------ |
| 反応遅延時間 | 0.1 〜 0.6 | 0.3    | 秒   | サーブに気づくまでの時間 |

### 2.3 分析機能

#### 2.3.1 リアルタイム計算結果
- **横移動距離** (m): レシーバーのX方向移動
- **前方移動距離** (m): レシーバーのZ方向移動
- **総移動距離** (m): 実際の移動距離（斜め）
- **レシーブ時間** (秒): サーブから打点までの時間
- **有効時間** (秒): 反応遅延を引いた実質移動可能時間
- **必要速度** (m/s): 有効時間内に到達するための必要移動速度
- **バウンド後Y方向進行** (m): バウンド後の前方進行距離
- **バウンド後X方向進行** (m): バウンド後の横方向進行距離
- **バウンド後Y方向速度** (m/s)
- **バウンド後X方向速度** (m/s)
- **難易度評価**: 必要速度に基づく4段階評価
  - 比較的容易: < 4 m/s
  - やや困難: 4〜6 m/s
  - 困難: 6〜8 m/s
  - 非常に困難: > 8 m/s

### 2.4 アニメーション機能
- **再生ボタン**: ボールが軌道に沿って移動するアニメーション
- **フレームレート**: 20ms/frame (または requestAnimationFrame に従う)
- **自動リセット**: アニメーション終了後、ボールは初期位置に戻る

---

## 3. 物理モデル設計

### 3.1 座標系
- **X軸**: 横方向（センターマークを0とし、右方向が正）
- **Y軸**: 高さ方向（地面を0とし、上方向が正）
- **Z軸**: 前後方向（サーバー側が負、レシーバー側が正）
- **ネット位置**: Z = 0, Y = 0.914m

### 3.2 サーブ軌道計算

**物理モデル**: 重力ベースの弾道計算（Ballistic Trajectory）

#### 3.2.1 基本方程式
- 重力加速度: g = 9.81 m/s²
- 初速度ベクトル: v₀ = (vₓ, vᵧ, vᵤ)
- 位置: r(t) = r₀ + v₀t - ½gt²ĵ

#### 3.2.2 打ち出し角度の逆算
ユーザーが指定する「軌道の最高点の高さ」と「最高点の位置」から、物理的に正しい打ち出し角度を逆算：

1. 最高点での条件: vᵧ = 0
2. 最高点の高さ: h_peak = h₀ + vᵧ₀² / (2g)
3. 最高点までの時間: t_peak = vᵧ₀ / g
4. 最高点までの水平距離: d_peak = vₓ × t_peak

これらの式から、ユーザー指定のパラメータに基づいて打ち出し角度θを計算。

#### 3.2.3 双方向制御
- **着弾点指定モード**: 着弾点(X, Z)を指定すると、ネットを越える最速のサーブになるように速度と軌道パラメータを最適化
- **物理パラメータ指定モード**: 速度や軌道パラメータを変更すると、実際の着弾点を計算して表示

詳細実装: `src/core/PhysicsEngine.ts`

### 3.3 レシーバー分析計算
(詳細は変更なしのため省略。`src/core/PhysicsEngine.ts` に実装)

---

## 4. データ構造設計 (TypeScript 型定義)

### 4.1 型定義 (`src/types/index.ts`)
```typescript
interface ServeConfig {
  serveSpeed: number;             // km/h
  trajectoryPeakHeight: number;   // m (軌道の最高点の高さ)
  peakPosition: number;           // m (最高点の位置、ネット基準)
  targetX: number;                // m (着弾点X座標)
  targetZ: number;                // m (着弾点Z座標)
  serverHeight: number;           // m (打点高さ)
  bounceVelocityRetention: number; // ratio
  reactionDelay: number;          // seconds
  serverPositionX: number;        // m
  showDimensions: boolean;
}

interface AnalysisResult {
  receiverStart: { x: number; z: number };
  receiverTarget: { x: number; z: number };
  moveX: number;
  moveZ: number;
  totalDistance: number;
  receiveTime: number;
  effectiveTime: number;
  requiredSpeed: number;
  difficulty: string;
  bounceDistanceY: number; // Z方向距離
  bounceDistanceX: number;
  bounceVelocityY: number; // Z方向速度
  bounceVelocityX: number;
}
```

---

## 5. コンポーネント・アーキテクチャ設計

### 5.1 ディレクトリ構成
```
src/
├── core/                 # 純粋ロジック (ViewやReactに依存しない)
│   ├── PhysicsEngine.ts  # 軌道計算・分析ロジック
│   └── CourtConstants.ts # コート寸法定義
├── graphics/             # Three.js 関連クラス
│   ├── SceneController.ts     # Scene, Camera, Renderer管理
│   ├── CourtVisualizer.ts     # コート描画
│   ├── TrajectoryVisualizer.ts # 軌道・マーカー描画
│   └── BallVisualizer.ts      # ボール描画
├── components/           # UIコンポーネント (React)
│   ├── ControlPanel.tsx  # 設定操作パネル
│   └── AnalysisPanel.tsx # 分析結果表示
├── features/             # 機能・シーンごとの統合
│   └── serve/
│       └── ServeScene.tsx # サーブシミュレーター機能統合
├── App.tsx               # アプリケーションルート
└── main.tsx              # エントリーポイント
```

### 5.2 アーキテクチャ概要
従来のモノリシックな構造から、責務を分離したレイヤードアーキテクチャへ移行。

1.  **Core Layer**: `src/core`
    *   物理計算や定数のみを保持。Three.jsやReactには依存せず、テスティング容易性を確保。
2.  **Graphics Layer**: `src/graphics`
    *   Three.jsの複雑な命令をクラスに隠蔽。
    *   `SceneController` がレンダリングループを管理。
    *   各 `Visualizer` が担当オブジェクトの生成・更新を行う。
3.  **UI Layer**: `src/components`
    *   DOM要素（HTML）としてのUIを担当。
    *   表示ロジックのみを持ち、ドメインロジックは持たない。
4.  **Feature Layer**: `src/features`
    *   上記レイヤーを統合し、特定の機能（シーン）を実現する。
    *   `ServeScene` は React State を持ち、Core で計算し、Graphics に反映し、UI に状態を渡す。

---

## 6. UI設計

### 6.1 レイアウト
```
┌─────────────────────────────────────┐
│                                     │
│          3D Canvas (flex: 1)        │
│                                     │
│                                     │
│                                     │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│  Control Panel (maxHeight: 400px)   │
│  [Param Inputs]                     │
│  [Animation Button]                 │
│  [Analysis Results]                 │
└─────────────────────────────────────┘
```

### 6.2 カラースキーム
(変更なし)

---

## 7. 非機能要件

### 7.1 パフォーマンス
- レンダリング: Three.js のレンダリングループを使用し 60fps を目指す。
- 事前バンドル: Vite によりロード時間を短縮。

### 7.2 互換性
- ES Modules 対応ブラウザ。

---

## 8. 制約事項
- ステートは React Hooks (`useState`) で管理し、ページリロードでリセットされる。
- 物理モデルの簡易性は維持（空気抵抗なし等）。

---

## 9. 今後の拡張可能性
- **ボレー/ラリー対応**: `PhysicsEngine` の拡張と、`src/features/rally/` などの新規シーン作成により対応可能。
- **Electron化**: 本構成 (`vite-project`) をそのままラップしてデスクトップアプリ化が可能。

---

## 10. 参考資料
(変更なし)

---

## 11. 人形モーション実装（将来的拡張）
(変更なし)

---

**文書バージョン**: 1.3
**最終更新日**: 2026年1月2日
**更新履歴**:
- v1.0: 初版作成
- v1.1: 人形モーション実装に関するセクション追加
- v1.2: アーキテクチャ刷新に伴う全面更新 (Vite + React + TypeScript, モジュール分割)
- v1.3: 物理モデル変更（重力ベース弾道計算）、パラメータ体系変更（直感的な軌道制御）